
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://ricky1981.github.io/blog/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://ricky1981.github.io/blog/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://ricky1981.github.io/blog/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://ricky1981.github.io/blog/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://ricky1981.github.io/blog/theme/font-awesome/css/solid.css">







<meta name="author" content="Seb" />
<meta name="description" content="Virtualisation" />
<meta name="keywords" content="projet, OpenClassRooms, vagrant, docker">


<meta property="og:site_name" content="Mon Blog Freelance"/>
<meta property="og:title" content="Projet 03 - Créez votre environnement de travail local"/>
<meta property="og:description" content="Virtualisation"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://ricky1981.github.io/blog/projet-03-creez-votre-environnement-de-travail-local.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-12-07 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://ricky1981.github.io/blog/author/seb.html">
<meta property="article:section" content="Accueil"/>
<meta property="article:tag" content="projet"/>
<meta property="article:tag" content="OpenClassRooms"/>
<meta property="article:tag" content="vagrant"/>
<meta property="article:tag" content="docker"/>
<meta property="og:image" content="imagesperso/CICD01.png">

  <title>Mon Blog Freelance &ndash; Projet 03 - Créez votre environnement de travail local</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://ricky1981.github.io/blog">
        <img src="imagesperso/CICD01.png" alt="DevOps Tuto" title="DevOps Tuto">
      </a>

      <h1>
        <a href="https://ricky1981.github.io/blog">DevOps Tuto</a>
      </h1>

<p>Lancez vous dans l'automatisation!!!</p>


      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/Ricky1981" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/sebastien-rykala-7767b81ba/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://ricky1981.github.io/blog">Home</a>

      <a href="archives.html">Archives</a>
      <a href="categories.html">Categories</a>
      <a href="tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="projet-03-creez-votre-environnement-de-travail-local">Projet 03 - Créez votre environnement de travail local</h1>
    <p>
      Posted on Mon 07 December 2020 in <a href="https://ricky1981.github.io/blog/category/accueil.html">Accueil</a>

    </p>
  </header>


  <div>
    <p>Le but de ce premier "vrai" projet du parcours "Expert DevOps" d'OpenClassRooms est de mettre en place un environnement de développement de manière automatique en local sur notre poste. 
En effet, la démarche DevOps est constituée de nombreuses tâches, au service des différent pôles informatiques, développeurs, exploitation, testing, etc. 
C'est pourquoi il est important de pouvoir créer un environnement qui, à l'image des serveurs cibles, permet aux développeurs de travailler sur un environnement qui reproduit les conditions dans lesquelles leur code fonctionnera.</p>
<p>Nous vous proposons ici deux méthodes pour utiliser une machine virtuelle sous Vagrant :</p>
<ul>
<li><a href="#cas1">Utiliser une machine entièrement fonctionnelle</a> </li>
<li><a href="#cas2">Créer vous-même votre environnement</a></li>
</ul>
<p>De plus, nous vous présenterons une <a href="#cas3">troisième partie</a> sur docker et notre premier Dockerfile</p>
<h1>Utiliser une machine entièrement fonctionnelle <a name="cas1"></a></h1>
<h2>Prérequis <a name="prerequis"></a></h2>
<ul>
<li><a href="https://git-scm.com/book/fr/v2/D%C3%A9marrage-rapide-Installation-de-Git">Git</a> ~&gt; 2.20</li>
<li><a href="https://www.vagrantup.com/docs/installation">Vagrant</a> ~&gt; 2.2.6</li>
<li>Plugin scp de vagrant : <code>vagrant plugin install vagrant-scp</code> </li>
<li>Plugin vbguest de vagrant : <code>vagrant plugin install vagrant-vbguest</code></li>
<li><a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox ainsi que son pack d'extension</a> ~&gt; 6.1.16</li>
</ul>
<h2>Installation de la machine virtuelle "vierge"</h2>
<ol>
<li>Créer un repertoire sur poste, par exemple "vagrant" : <code>mkdir ~/vagrant</code></li>
<li>Se déplacer dans le répertoire "vagrant" : <code>cd ~/vagrant</code></li>
<li>Récupérer la dernière version du repository en lançant la commande suivante : <code>git clone --depth 1 https://github.com/Ricky1981/OpenClassRooms_Projet3_Vagrant.git .</code></li>
<li>Lancer la construction via la commande <code>vagrant up</code></li>
<li>Après un certain temps, la machine virtuelle est créée et il vous est possible de prendre la main à distance en ssh via la commande <code>vagrant ssh</code> (si vous souhaitez une autre méthode de connection, merci de consulter la section <a href="#ssh">suivante</a>)</li>
</ol>
<h2>Test des différents outils sur la machine virtuelle</h2>
<p>Les composants du tableaux ci-dessous sont les composants qui ont été ajouté dans le Vagrantfile et ne proviennent donc pas de l'image par défaut.
Toutes les commandes ci-dessous sont à faire une fois la connection SSH sur l'hôte distant est opérationnel :</p>
<table>
<thead>
<tr>
<th>Composant</th>
<th>Commande</th>
<th>Retour</th>
</tr>
</thead>
<tbody>
<tr>
<td>Editeur de texte</td>
<td><code>vim --version</code></td>
<td>VIM - Vi IMproved 8.1</td>
</tr>
<tr>
<td>Ansible</td>
<td><code>ansible --version</code></td>
<td>ansible 2.9.15</td>
</tr>
<tr>
<td>Docker</td>
<td><code>docker --version</code></td>
<td>Docker version 19.03.14</td>
</tr>
</tbody>
</table>
<h2><a name="ssh"></a> Configuration SSH</h2>
<p>Ce paragraphe vous propose de configurer SSH sur votre poste afin d'utiliser la façon commune à l'utilisation de la commande ssh.
Vagrant se connecte parfaitement via la commande <code>vagrant ssh</code>. 
Cependant, si vous souhaitez utiliser la commande <code>ssh [user]@[IP]</code>, il faudra ajouter des informations dans le fichier ~/.ssh/config.
Ci-dessous les étapes à respecter : 
1°/ Nous consultons la configuration ssh de vagrant via la commande <code>vagrant ssh-config</code> :</p>
<div class="highlight"><pre><span></span><code>Host default
  HostName 127.0.0.1
  User vagrant
  Port 2222
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /home/seb/.vagrant.d/insecure_private_key
  IdentitiesOnly yes
  LogLevel FATAL`
</code></pre></div>

<p>2°/ Vagrant nous affiche alors la configuration qu'il utilise. Comme on connait l'adresse IP de la machine et le chemin vers sa clé privée, on peut se rendre dans le fichier <code>~/.ssh/config</code> pour ajouter une configuration :</p>
<div class="highlight"><pre><span></span><code>Host 192.168.33.10
  User vagrant
  Port 22
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /home/seb/.vagrant.d/insecure_private_key
  IdentitiesOnly yes
  LogLevel FATAL
</code></pre></div>

<p>La configuration sera ainsi utilisée avec la bonne clé privée et la connexion peut être établie via la commande <code>ssh [user]@[IP]</code></p>
<h1>Créer vous-même votre environnement <a name="cas2"></a></h1>
<p>Ici, nous allons créer notre premiere version du fichier “Vagrantfile”.
Les prérequis sont les mêmes que pour la <a href="#prerequis">première partie</a> de cette page 
Pour cela, nous lançons juste la commande suivante afin de générer le fichier “initiale”  </p>
<div class="highlight"><pre><span></span><code>$ vagrant init 
A <span class="sb">`</span>Vagrantfile<span class="sb">`</span> has been placed <span class="k">in</span> this directory. You are now ready to <span class="sb">`</span>vagrant up<span class="sb">`</span> your first virtual environment! Please <span class="nb">read</span> the comments <span class="k">in</span> the Vagrantfile as well as documentation on 
<span class="sb">`</span>vagrantup.com<span class="sb">`</span> <span class="k">for</span> more information on using Vagrant. 
</code></pre></div>

<h2>Création du Vagrantfile de ma distribution</h2>
<p>Mon choix s’est porté sur un Debian 10.6.0 en version LXQt Desktop car légère</p>
<h3>Création de la VM dans VirtualBox</h3>
<p>Notre machine s’intitulera “vagrant-debian10.6.0”</p>
<p><img alt="VirtualBox001" src="imagesperso/projet03/VirtualBox001.png"></p>
<p>L’utilisateur “vagrant” est créé sur cette VM avec login = mot de passe</p>
<p>Une fois l’OS installé sur cette VM, on configure la redirection de port : </p>
<p><img alt="VirtualBox002" src="imagesperso/projet03/VirtualBox002.png"></p>
<p>Enfin, lancer la VM et se connecter dessus. 
Passer ensuite en root et installer SSH ainsi que sudo via un terminal : </p>
<div class="highlight"><pre><span></span><code>vagrant@vagrant-debian10:~$ su 
Mot de passe : 
root@vagrant-debian10:~# apt-get install ssh sudo 
</code></pre></div>

<p>Nous rajoutons également le package suivant afin de pouvoir ajouter des repository si besoin par la suite (apt-add-repository) car par défaut, n’est pas installé : </p>
<div class="highlight"><pre><span></span><code>sudo apt-get install software-properties-common 
</code></pre></div>

<p>On va ensuite modifier la configuration du fichier sudoers pour autoriser tous les utilisateurs du groupe admin à sudoer sans mot de passe. </p>
<div class="highlight"><pre><span></span><code> <span class="c1"># visudo </span>
</code></pre></div>

<p>Nous ajoutons l’utilisateur vagrant :</p>
<div class="highlight"><pre><span></span><code>vagrant   <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span>   NOPASSWD: ALL 
</code></pre></div>

<p>Enfin, on teste notre utilisateur vagrant afin de vérifier que le mot de passe ne soit plus necessaire.  </p>
<div class="highlight"><pre><span></span><code><span class="c1"># exit </span>
$ sudo ls 
</code></pre></div>

<p>Ensuite :</p>
<div class="highlight"><pre><span></span><code>mkdir ~/.ssh 
$ touch authorized_keys 
</code></pre></div>

<p>Puis ajouter dans authorized_keys la clé publique : </p>
<div class="highlight"><pre><span></span><code>ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ<span class="o">==</span> vagrant insecure public key 
</code></pre></div>

<p>Puis on donne les bons droits : </p>
<div class="highlight"><pre><span></span><code>$ chmod <span class="m">0700</span> ~/.ssh 
$ chmod <span class="m">0600</span> ~/.ssh/authorized_keys 
</code></pre></div>

<p>Il faut aussi installer la VBoxGuestAddition de notre version sinon problème lors du mount (voir https://www.vagrantup.com/docs/providers/virtualbox/boxes.html) </p>
<div class="highlight"><pre><span></span><code>wget http://download.virtualbox.org/virtualbox/6.1.16/VBoxGuestAdditions_6.1.16.iso  
sudo mkdir /media/VBoxGuestAdditions 
sudo mount -o loop,ro VBoxGuestAdditions_6.1.16.iso /media/VBoxGuestAdditions 
sudo sh /media/VBoxGuestAdditions/VBoxLinuxAdditions.run 
rm VBoxGuestAdditions_6.1.16.iso 
sudo umount /media/VBoxGuestAdditions 
sudo rmdir /media/VBoxGuestAdditions 
</code></pre></div>

<p>Si erreur de type : “Kernel header not found for targert kernel 4.19... Please install them and execute /sbin/rcvboxadd setup” 
Faire :  </p>
<div class="highlight"><pre><span></span><code>sudo apt-get install build-essential linux-headers-<span class="sb">`</span>uname -r<span class="sb">`</span> dkms 
</code></pre></div>

<p>et on relance le VBoxLinuxAdditons.run 
Quand tout est OK, on se déconnecte et on éteint la machine. </p>
<h3>Packaging</h3>
<p>Nous avons donc une machine virtuelle nommée vagrant-debian10.6.0 dans Virtualbox. Nous allons la packager pour en faire une box. On se place dans le repertoire suivant : ~/Bureau/ownCloud/OpenClassRoom/Projet_03/vagrantBox/ </p>
<p>Puis on lance la commande suivante : </p>
<div class="highlight"><pre><span></span><code>$ vagrant package --base vagrant-debian10.6.0 
</code></pre></div>

<p>Le paramètre base est le nom de la VM dans VirtualBox. Un traitement un peu long va se produire et à la fin, vous obtiendrez un fichier package.box. Ce fichier, rangez le dans un endroit accessible à vos futures config vagrant : soit en le laissant dans ce dossier, soit en la mettant sur un serveur http. </p>
<div class="highlight"><pre><span></span><code>$ vagrant package --base vagrant-debian10.6.0 
<span class="o">==</span>&gt; vagrant-debian10.6.0: Exporting VM... 
<span class="o">==</span>&gt; vagrant-debian10.6.0: Compressing package to: /home/seb/Bureau/ownCloud/OpenClassRoom /Projet_03/vagrantBox/ 
</code></pre></div>

<p>On renomme le fichier package.box pour retrouver le nom de notre VM à savoir vagrant-debian10.6.0.box </p>
<div class="highlight"><pre><span></span><code>$ mv package.box vagrant-debian10.6.0.box 
</code></pre></div>

<h3>Test</h3>
<p>On modifie le VagrantiFile initial comme suit : </p>
<div class="highlight"><pre><span></span><code>Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span> 
<span class="c1"># The most common configuration options are documented and commented below    . </span>
<span class="c1"># For a complete reference, please see the online documentation at </span>
<span class="c1"># https://docs.vagrantup.com. </span>
<span class="c1"># Every Vagrant development environment requires a box. You can search for </span>
<span class="c1"># boxes at https://vagrantcloud.com/search. </span>
config.vm.box <span class="o">=</span> <span class="s2">&quot;vagrant-debian10.6.0&quot;</span> 
config.vm.box_url <span class="o">=</span> <span class="s2">&quot;file:///home/seb/Bureau/ownCloud/OpenClassRoom/Projet_03/vagrantBox/vagrant-debian10.6.0.box&quot;</span> 
</code></pre></div>

<p>Et test du vagrant : </p>
<div class="highlight"><pre><span></span><code>$ vagrant up 
</code></pre></div>

<h1>Notre premier fichier Docker <a name="cas3"></a></h1>
<h2>Lancement du Dockerfile</h2>
<p>Une fois connecté sur la machine virtuelle "vagrant" en SSH que nous venons de créer, veuillez lancer les actions suivantes :</p>
<ol>
<li>Vérifier que nous nous situons bien dans le HOME de l'utilisateur vagrant : <code>cd ~</code></li>
<li>Récupérer la dernière version du repository dans lequel toutes les sources sont présentes en lançant la commande suivante : <code>git clone --depth 1 https://github.com/Ricky1981/OpenClassRooms_Projet3_Docker.git</code></li>
<li>Construire le conteneur à partir du DockerFile : <code>docker build -t image_perso OpenClassRooms_Projet3_Docker/</code></li>
<li>Lancer le conteneur : <code>docker run -d -p 8080:80 --name Projet03 image_perso</code></li>
<li>Vérifier que le conteneur est bien actif : <code>docker ps</code>  </li>
<li>Revenir sur sa machine local et tester l'URL suivante : http://192.168.33.10:8080 </li>
<li>Si vous souhaitez arreter le conteneur : <code>docker stop Projet03</code></li>
</ol>
<h2>Explication du fichier</h2>
<p>Voici le fichier Dockerfile du repository que vous avez recuperé. Nous détaillerons toutes les lignes de ce premier fichier très simple à comprendre</p>
<div class="highlight"><pre><span></span><code>FROM debian:stable-slim

RUN apt update <span class="o">&amp;&amp;</span> <span class="se">\</span>
apt install -y nginx

COPY ./index.html /var/www/html/

EXPOSE <span class="m">80</span>

CMD <span class="o">[</span><span class="s2">&quot;nginx&quot;</span>, <span class="s2">&quot;-g&quot;</span>, <span class="s2">&quot;daemon off;&quot;</span><span class="o">]</span>
</code></pre></div>

<h3>Ligne "FROM"</h3>
<p>Cette ligne nous permet de recuperer l'image debian sur le site <a href="https://hub.docker.com/">DockerHub</a>.
Vous pouvez suivre les étapes suivantes pour comprendre comment rechercher une image docker :</p>
<p>Sur <a href="https://hub.docker.com/">DockerHub</a> faire un filtre sur les images officiels afin de pouvoir récuperer l’image Debian :</p>
<p><img alt="Docker001" src="imagesperso/projet03/Docker001.png"></p>
<p>Cliquer sur le lien </p>
<p>Une fois sur la page suivante choisir sa version. De mon côté, je décide de prendre la version stable : </p>
<p><img alt="Docker002" src="imagesperso/projet03/Docker002.png"></p>
<h3>Ligne "RUN"</h3>
<p>Cette ligne nous permet de lancer l'installation des package dont nous avons besoin. En l'occurence ici nous avons juste besoin de NGINX.</p>
<h3>Ligne "COPY"</h3>
<p>Dans le repository que vous venez de recuperer, le fichier index.html est un fichier "customisé" afin de verifier que notre installation fonctionne correctement.
Ici, nous copions juste ce fichier index.html que nous plaçons dans le repertoire que NGINX utilisera à savoir /var/www/html</p>
<p>Nous aurions pu ici aller plus loin en créant un Volume afin de pouvoir l'alimenter depuis notre poste local.</p>
<h3>Ligne "EXPOSE"</h3>
<p>Ici, comme son nom l'indique nous souhaitons "Exposer" le port 80 de notre conteneur. Sans cette ligne de commande, nous ne pourrons pas accéder à notre page HTML.</p>
<h3>Ligne "CMD"</h3>
<p>Nous souhaitons ici indiqué à docker que nous ne souhaitons pas que le daemon NGINX soit lancé lors de l'appel du conteneur Docker.
En effet, c'est Docker qui portera notre site Web. Il ne faut donc pas "doublonner" les actions.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://ricky1981.github.io/blog/tag/projet.html">projet</a>
      <a href="https://ricky1981.github.io/blog/tag/openclassrooms.html">OpenClassRooms</a>
      <a href="https://ricky1981.github.io/blog/tag/vagrant.html">vagrant</a>
      <a href="https://ricky1981.github.io/blog/tag/docker.html">docker</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy; 2020 Test Copyright</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Mon Blog Freelance ",
  "url" : "https://ricky1981.github.io/blog",
  "image": "imagesperso/CICD01.png",
  "description": ""
}
</script>


</body>
</html>